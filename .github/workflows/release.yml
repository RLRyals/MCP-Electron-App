name: Release Electron App

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build Windows app
        run: npm run package:win
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Generate checksums
        shell: powershell
        run: |
          $releaseDir = Join-Path $PWD 'out\release'
          New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null

          Get-ChildItem -Path (Join-Path $PWD 'out') -Filter *.exe -Recurse -File |
            Where-Object { $_.FullName -notlike "$releaseDir\*" } |
            ForEach-Object {
              $hash = Get-FileHash -Path $_.FullName -Algorithm SHA256
              $filename = $_.Name
              "$($hash.Hash.ToLower())  $filename" | Out-File -Append -FilePath (Join-Path $PWD 'out\checksums-windows.txt') -Encoding utf8

              $dest = Join-Path $releaseDir $filename
              Copy-Item -Path $_.FullName -Destination $dest -Force
            }

          Get-Content out/checksums-windows.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            out/release/*.exe
            out/checksums-windows.txt
          retention-days: 1

  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build macOS app
        run: npm run package:mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Generate checksums
        run: |
          cd out
          find . -type f \( -name "*.dmg" -o -name "*.zip" \) -exec sh -c '
            for file; do
              filename=$(basename "$file")
              shasum -a 256 "$file" | sed "s|$file|$filename|" >> checksums-macos.txt
            done
          ' sh {} +
          cat checksums-macos.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            out/*.dmg
            out/*.zip
            out/checksums-macos.txt
          retention-days: 1

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build Linux app
        run: npm run package:linux

      - name: Generate checksums
        run: |
          cd out
          find . -type f \( -name "*.AppImage" -o -name "*.deb" \) -exec sh -c '
            for file; do
              filename=$(basename "$file")
              sha256sum "$file" | sed "s|$file|$filename|" >> checksums-linux.txt
            done
          ' sh {} +
          cat checksums-linux.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: |
            out/*.AppImage
            out/*.deb
            out/checksums-linux.txt
          retention-days: 1

  create-release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: always() && needs.build-windows.result == 'success' && needs.build-macos.result == 'success' && needs.build-linux.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: release-assets/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-installer
          path: release-assets/macos

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-installer
          path: release-assets/linux

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lR release-assets/

      - name: Generate release notes
        id: release_notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - showing all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Changes since $PREV_TAG"
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          cat << EOF > release_notes.md
          ## What's Changed

          $COMMITS

          ## Installation

          ### Windows
          Download and run the installer executable for Windows.

          ### macOS
          Download the DMG file, mount it, and drag the app to Applications.

          ### Linux
          **AppImage**: Download the AppImage file, make it executable, and run:
          \`\`\`bash
          chmod +x FictionLab-*.AppImage
          ./FictionLab-*.AppImage
          \`\`\`

          **Debian/Ubuntu**: Download and install the .deb package:
          \`\`\`bash
          sudo dpkg -i fictionlab_*.deb
          \`\`\`

          ## Checksums (SHA256)

          Checksums are included in the \`checksums-*.txt\` files for each platform.

          ## Notes

          - Code signing certificates are not yet configured (Windows and macOS may show security warnings)
          - Please verify checksums before installation
          EOF

          cat release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: FictionLab ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}
          files: |
            release-assets/windows/*.exe
            release-assets/windows/checksums-windows.txt
            release-assets/macos/*.dmg
            release-assets/macos/*.zip
            release-assets/macos/checksums-macos.txt
            release-assets/linux/*.AppImage
            release-assets/linux/*.deb
            release-assets/linux/checksums-linux.txt

  release-complete:
    name: Release Complete
    needs: [create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check release status
        run: |
          if [ "${{ needs.create-release.result }}" != "success" ]; then
            echo "::error::Release creation failed"
            echo "Release: ${{ needs.create-release.result }}"
            exit 1
          fi
          echo "::notice::Release completed successfully!"
